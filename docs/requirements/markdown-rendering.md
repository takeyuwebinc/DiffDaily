# 要件定義書: Markdownレンダリング機能

## 文書管理情報

| 項目 | 内容 |
|------|------|
| 文書ID | REQ-2026-001 |
| 作成日 | 2026-01-07 |
| 最終更新日 | 2026-01-07 |
| ステータス | Draft |

## 1. 背景・目的

### 1.1 背景

現在、DiffDailyではAI生成された技術記事をMarkdown形式でデータベースに保存しているが、表示時は`simple_format`を使用した簡易的なHTML変換を行っている。そのため、コードブロックのシンタックスハイライトや図表の表示など、技術記事として必要な表現力が不足している。

### 1.2 目的

Markdown記事を適切なHTMLに変換し、技術記事として必要な以下の機能を提供する：

- コードブロックのシンタックスハイライト
- 図表の描画
- リンク情報の豊富な表示
- 画像の拡張表示

### 1.3 スコープ

- **対象**: Post記事のbodyフィールド（Markdown形式）のHTML変換
- **範囲**: 記事詳細ページおよび記事一覧ページでの表示
- **参考実装**: rails-spotlightプロジェクトのカスタムMarkdown拡張機能を移植

## 2. 機能要件

### 2.1 基本Markdownレンダリング

**Must Have**

| ID | 要件 | 説明 |
|----|------|------|
| F-001 | Markdown→HTML変換 | Post記事のbodyをMarkdownからHTMLに変換して表示する |
| F-002 | 標準Markdown構文対応 | 見出し、リスト、引用、テーブル等の標準Markdown構文をサポートする |
| F-003 | 自動リンク | URLを自動的にリンクに変換する |

### 2.2 コードブロック機能

**Must Have**

| ID | 要件 | 説明 |
|----|------|------|
| F-101 | シンタックスハイライト | コードブロックをプログラミング言語に応じて色付け表示する |
| F-102 | コピーボタン | 各コードブロックにコードをクリップボードにコピーするボタンを表示する |
| F-103 | ファイル名表示 | コードブロックにファイル名を指定して表示できる（例: `ruby:app/models/post.rb`） |
| F-104 | 言語指定 | コードブロックでプログラミング言語を指定できる |

**機能詳細:**
- コピーボタンは各コードブロックの右上に配置する
- コピー成功時は視覚的フィードバックを提供する
- ファイル名はコードブロックの上部に表示する

### 2.3 図表描画機能

**Must Have**

| ID | 要件 | 説明 |
|----|------|------|
| F-201 | Mermaid図表対応 | Mermaid記法で記述された図表を描画する |
| F-202 | 図表タイプ対応 | フローチャート、シーケンス図、クラス図等のMermaid図表タイプをサポートする |

**機能詳細:**
- コードブロックで言語を`mermaid`と指定した場合、図表として描画する

### 2.4 リンクカード機能

**Must Have**

| ID | 要件 | 説明 |
|----|------|------|
| F-301 | URLリンクカード化 | URLのみの行をリンクカードとして表示する |
| F-302 | 外部リンク動作 | リンクカードをクリックすると新しいタブで開く |

**機能詳細:**
- 行にURLのみが記載されている場合、リンクカードとして表示する
- リンクカードには適切なスタイリングを適用する

### 2.5 拡張画像表示機能

**Must Have**

| ID | 要件 | 説明 |
|----|------|------|
| F-401 | 画像表示 | Markdown画像構文で画像を表示する |
| F-402 | 幅指定 | 画像の幅を指定できる（例: `![alt](path =300px)`） |
| F-403 | キャプション表示 | 画像の下にキャプションを表示できる |
| F-404 | リンク付き画像 | 画像をクリック可能なリンクにできる |

**機能詳細:**
- 画像は適切なレスポンシブ対応を行う
- キャプションは画像の直後に続く斜体テキストとして認識する

### 2.6 セキュリティ

**Must Have**

| ID | 要件 | 説明 |
|----|------|------|
| F-501 | XSS対策 | Content Security Policy（CSP）でスクリプト実行を制限する |
| F-502 | HTMLサニタイズ | 変換後のHTMLから危険なタグ・属性を除去する |
| F-503 | 外部リンク安全性 | 外部リンクは`rel="noopener"`を付与する |

**方針:**
- CSPヘッダーでアプリケーション全体のセキュリティを管理する（第一の防御層）
- Markdown→HTML変換後にHTMLサニタイズを実行する（第二の防御層）
- AI生成コンテンツであっても、元のGitHubリポジトリコードに含まれるスクリプトタグなどが記事に混入する可能性があるため、サニタイズを必須とする

**サニタイズ対象:**
- scriptタグ、iframeタグなどの実行可能要素
- onclickなどのイベントハンドラー属性
- javascript:スキームのURL

## 3. 非機能要件

### 3.1 パフォーマンス

**Should Have**

| ID | 要件 | 説明 |
|----|------|------|
| NF-101 | レンダリング効率 | 長文記事でも表示遅延が発生しないこと |

**方針:**
- 記事表示時にMarkdown→HTML変換を行う
- 必要に応じてキャッシュ化を検討（Phase 2以降）

### 3.2 互換性

**Must Have**

| ID | 要件 | 説明 |
|----|------|------|
| NF-201 | ブラウザ対応 | モダンブラウザ（Chrome, Firefox, Safari, Edge最新版）で動作すること |
| NF-202 | モバイル対応 | スマートフォン・タブレットで適切に表示されること |

## 4. 制約事項

### 4.1 技術的制約

| ID | 制約 | 説明 |
|----|------|------|
| C-001 | Markdownエンジン | redcarpet gemを使用する |
| C-002 | HTMLサニタイザー | rails-html-sanitizer gemまたは同等のサニタイザーを使用する |
| C-003 | シンタックスハイライト | highlight.jsを使用する |
| C-004 | 図表描画 | Mermaid.jsを使用する |
| C-005 | 参考実装 | rails-spotlightプロジェクトの実装を移植する |

### 4.2 前提条件

| ID | 前提 | 説明 |
|----|------|------|
| P-001 | コンテンツソース | 記事はAIによって生成されたものであり、ユーザー入力は想定しない |
| P-002 | Markdown形式 | bodyフィールドには有効なMarkdown形式のテキストが保存されている |

## 5. 用語定義

| 用語 | 定義 |
|------|------|
| Markdown | 軽量マークアップ言語の一種。プレーンテキストで記述し、HTMLに変換できる |
| シンタックスハイライト | プログラミング言語のコードを色分けして表示する機能 |
| Mermaid | テキストベースで図表を描画できるツール |
| リンクカード | URLを視覚的に表現したカード型UI |
| CSP | Content Security Policy。Webアプリケーションのセキュリティポリシーを定義する仕組み |

## 6. 受け入れ基準

### 6.1 機能受け入れ基準

- [ ] Markdown記事が適切なHTMLに変換されて表示される
- [ ] コードブロックがシンタックスハイライトされる
- [ ] コードブロックにコピーボタンが表示され、正常に動作する
- [ ] ファイル名付きコードブロックが正しく表示される
- [ ] Mermaid図表が描画される
- [ ] URLのみの行がリンクカードとして表示される
- [ ] 画像が適切に表示される
- [ ] 幅指定・キャプション付き画像が正しく表示される

### 6.2 品質受け入れ基準

- [ ] モダンブラウザで正常に動作する
- [ ] モバイルデバイスで適切に表示される
- [ ] CSPが適切に設定されている
- [ ] HTMLサニタイズが正しく動作している（scriptタグ等が除去される）
- [ ] 外部リンクに`rel="noopener"`が付与されている

## 7. 参考資料

### 7.1 参考実装

- rails-spotlightプロジェクト
  - `lib/custom_markdown_extensions.rb`: カスタムMarkdown拡張
  - `app/javascript/controllers/syntax_highlight_controller.js`: シンタックスハイライトコントローラー

### 7.2 使用ライブラリ

- redcarpet: Markdown→HTML変換エンジン
- highlight.js: シンタックスハイライトライブラリ
- Mermaid.js: 図表描画ライブラリ

## 8. 変更履歴

| 日付 | バージョン | 変更内容 | 作成者 |
|------|------------|----------|--------|
| 2026-01-07 | 1.0 | 初版作成 | Claude |
