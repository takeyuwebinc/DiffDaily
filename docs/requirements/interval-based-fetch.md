# インターバルベースPR取得機能 要件定義書

**作成日**: 2026年1月10日
**更新日**: 2026年1月10日

## 1. 機能概要

PR取得処理を定時一括実行から、リポジトリごとの経過時間に基づく分散実行に変更する。

**背景**：
- 現状、毎日午前6時に全リポジトリを一括で処理している
- 監視対象リポジトリが増加すると、処理が特定時刻に集中し負荷が偏る

**主要な提供価値**：
- PR取得処理の時間的分散による負荷の平準化
- リポジトリ数増加時のスケーラビリティ確保

## 2. 機能要件

### 2.1 基本処理フロー

1. **定期チェックジョブの実行**
   - 30分ごとに全リポジトリの取得状況をチェックする
   - 各リポジトリの最終取得日時（last_fetched_at）を参照する

2. **取得対象リポジトリの判定**
   - 最終取得日時から取得間隔（デフォルト24時間）が経過したリポジトリを対象とする
   - last_fetched_atがNULLのリポジトリは即座に取得対象とする

3. **PR取得の実行**
   - 取得対象と判定されたリポジトリに対してのみDailySummaryJobを実行する
   - 既存のPR取得ロジック（last_fetched_at起点の取得、重複チェック）を維持する

### 2.2 設定仕様

- **チェック間隔**: 30分（固定）
- **取得間隔**: 24時間（システム全体で共通）

### 2.3 既存機能との関係

- **PR取得漏れ防止機能との統合**: last_fetched_atの管理ロジックは既存実装を維持する
- **DailySummaryJob**: 既存の処理ロジックを変更しない
- **DailyRepositoryCheckJob**: 定時一括実行から定期チェック方式に変更する

## 3. 前提条件・制約事項

### 3.1 前提条件

- repositoriesテーブルにlast_fetched_atカラムが存在すること
- PR取得漏れ防止機能が実装済みであること

### 3.2 制約事項

- GitHub APIのrate limitに従う（既存制約）
- チェック時に取得間隔を超えたリポジトリが複数存在する場合、それらは同時に処理対象となる

## 4. 用語定義

| 用語 | 説明 |
|------|------|
| チェック間隔 | リポジトリの取得状況を確認するジョブの実行間隔（30分） |
| 取得間隔 | リポジトリごとのPR取得を行う最小間隔（24時間） |
| last_fetched_at | リポジトリごとにPRを最後に取得した日時 |

## 5. 受け入れ条件

- [ ] 30分ごとに全リポジトリの取得状況がチェックされること
- [ ] 最終取得から24時間以上経過したリポジトリのみがPR取得対象となること
- [ ] last_fetched_atがNULLのリポジトリが即座に取得対象となること
- [ ] 取得間隔未満のリポジトリはスキップされること
- [ ] 既存のPR取得ロジック（重複チェック、エラー時の再取得）が維持されること
- [ ] 複数リポジトリが登録されている場合、取得タイミングが自然に分散されること

---

## 改訂履歴

| バージョン | 日付 | 変更内容 |
|------------|------|----------|
| 1.0 | 2026/01/10 | 初版作成 |
