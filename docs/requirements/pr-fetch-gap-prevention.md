# Pull Request取得漏れ防止機能 要件定義書

**作成日**: 2026年1月10日
**更新日**: 2026年1月10日

## 1. 機能概要

DailySummaryJobにおいて、ジョブ実行間隔と取得対象期間のずれによるPull Request取得漏れを防止する。

現状、24時間間隔でジョブを実行し、過去24時間のPRを取得しているが、ジョブの実行遅延やサーバー再起動により、一部のPRが取得されない可能性がある。

**主要な提供価値**：
- マージされたPull Requestの取得漏れをなくす
- ジョブ実行タイミングに依存しない確実なデータ取得

## 2. 機能要件

### 2.1 基本処理フロー

1. **最終取得日時の参照**
   - ジョブ実行時、対象リポジトリの最終取得日時を参照する
   - 最終取得日時が未設定の場合は、24時間前を起点とする

2. **Pull Requestの取得**
   - 最終取得日時から現在までにマージされたPull Requestを取得する
   - 既存の重複チェック（source_urlによる判定）は維持する

3. **最終取得日時の更新**
   - ジョブが正常に完了した場合、最終取得日時を現在時刻に更新する
   - ジョブが異常終了した場合、最終取得日時は更新しない（次回実行時に再取得可能とする）

### 2.2 データ仕様

- **データソース**: repositoriesテーブル
- **追加項目**: 最終取得日時（last_fetched_at）
  - NULL許容（初回実行時は未設定）
  - タイムゾーン付きの日時型

### 2.3 エラー処理

- **ジョブ異常終了時**: 最終取得日時を更新せず、次回実行時に同じ期間を再取得可能とする
- **GitHub API エラー時**: 既存のエラーハンドリングを維持

## 3. 前提条件・制約事項

### 3.1 前提条件

- repositoriesテーブルが存在すること
- DailySummaryJobが定期実行されていること

### 3.2 制約事項

- GitHub APIの rate limit に従う（既存制約）
- 最終取得日時の更新はジョブ正常完了後のみ

## 4. 用語定義

| 用語 | 説明 |
|------|------|
| last_fetched_at | リポジトリごとにPRを最後に取得した日時 |
| DailySummaryJob | GitHubリポジトリの変更を取得し記事を生成するバックグラウンドジョブ |

## 5. 受け入れ条件

- [ ] リポジトリに最終取得日時が記録されること
- [ ] 最終取得日時以降にマージされたPRが取得されること
- [ ] 初回実行時（last_fetched_atがNULL）は過去24時間のPRが取得されること
- [ ] ジョブ正常完了後に最終取得日時が更新されること
- [ ] ジョブ異常終了時は最終取得日時が更新されないこと
- [ ] 既存の重複チェック（source_url）が引き続き機能すること

---

## 改訂履歴

| バージョン | 日付 | 変更内容 |
|------------|------|----------|
| 1.0 | 2026/01/10 | 初版作成 |
