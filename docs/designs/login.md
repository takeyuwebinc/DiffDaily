# 機能設計書：ログイン機能

## 1. 概要

### 1.1 機能概要

DiffDailyの管理画面へのアクセスを制御するための認証機能。Google OAuth2を使用し、特定ドメインのアカウントのみにアクセスを許可する。

### 1.2 関連要件

- [要件定義書：ログイン機能](../requirements/login.md)

## 2. 機能構成

### 2.1 機能一覧

| 機能ID | 機能名 | 概要 |
|--------|--------|------|
| F-001 | ログイン | Google OAuth2によるログイン |
| F-002 | ログアウト | セッション破棄 |
| F-003 | 認証チェック | 管理画面アクセス時の認証確認 |
| F-004 | リポジトリ一覧 | 登録済みリポジトリの表示 |
| F-005 | リポジトリ登録 | 新規リポジトリの登録 |
| F-006 | リポジトリ削除 | 登録済みリポジトリの削除 |

## 3. 認証機能

### 3.1 ログイン（F-001）

#### 責務

ユーザーがGoogleアカウントを使用して管理画面にログインする。

#### 処理フロー

1. **ログイン開始**
   - ユーザーがログインボタンをクリック
   - GoogleのOAuth認証画面にリダイレクト

2. **Google認証**
   - ユーザーがGoogleアカウントを選択・認証
   - 認証成功後、コールバックURLにリダイレクト

3. **ドメイン検証**
   - 認証情報からメールアドレスを取得
   - メールアドレスのドメインが許可ドメインか検証
   - 許可ドメイン: `@takeyuweb.co.jp`

4. **セッション作成**
   - ドメイン検証成功: セッションにユーザー情報を保存、管理画面トップにリダイレクト
   - ドメイン検証失敗: エラーメッセージを表示、ログイン画面にリダイレクト

#### 入力

| 項目 | 説明 |
|------|------|
| Google認証情報 | OAuth2コールバックで取得される認証情報 |

#### 出力

| 項目 | 説明 |
|------|------|
| セッション | ユーザー情報（メールアドレス、名前、アバターURL） |

#### ビジネスルール

- `@takeyuweb.co.jp` ドメインのメールアドレスのみ許可
- 事前のユーザー登録は不要（ドメイン一致で自動許可）

### 3.2 ログアウト（F-002）

#### 責務

ユーザーのセッションを破棄し、ログアウト状態にする。

#### 処理フロー

1. ユーザーがログアウトボタンをクリック
2. セッション情報を破棄
3. 公開トップページにリダイレクト

### 3.3 認証チェック（F-003）

#### 責務

管理画面へのアクセス時に、ユーザーがログイン済みか確認する。

#### 処理フロー

1. **セッション確認**
   - 管理画面へのリクエスト受信時にセッション情報を確認

2. **認証判定**
   - ログイン済み: リクエストを処理
   - 未ログイン: リクエストURLを保存し、ログイン画面にリダイレクト

3. **ログイン後リダイレクト**
   - ログイン成功後、保存していたURLにリダイレクト
   - 保存URLがない場合は管理画面トップにリダイレクト

## 4. リポジトリ管理機能

### 4.1 リポジトリ一覧（F-004）

#### 責務

登録済みのGitHubリポジトリを一覧表示する。

#### 処理フロー

1. 登録済みリポジトリを取得
2. 一覧形式で表示

#### 表示項目

| 項目 | 説明 |
|------|------|
| リポジトリ名 | リポジトリの識別名 |
| URL | GitHubリポジトリのURL |
| 最終取得日時 | PRを最後に取得した日時 |
| 投稿数 | 関連する投稿の件数 |
| 操作 | 削除ボタン |

### 4.2 リポジトリ登録（F-005）

#### 責務

新規のGitHubリポジトリを監視対象として登録する。

#### 処理フロー

1. **入力**
   - ユーザーがリポジトリ名とURLを入力

2. **バリデーション**
   - リポジトリ名: 必須、一意
   - URL: 必須、有効なURL形式

3. **登録**
   - バリデーション成功: リポジトリを登録、一覧にリダイレクト
   - バリデーション失敗: エラーメッセージを表示、入力画面を再表示

#### 入力項目

| 項目 | 必須 | 説明 |
|------|------|------|
| リポジトリ名 | ○ | リポジトリの識別名（例: rails/rails） |
| URL | ○ | GitHubリポジトリのURL |

### 4.3 リポジトリ削除（F-006）

#### 責務

登録済みリポジトリを削除する。

#### 処理フロー

1. **削除確認**
   - ユーザーが削除ボタンをクリック
   - 確認ダイアログを表示

2. **削除処理**
   - 確認OK: リポジトリと関連する投稿を削除
   - 確認キャンセル: 処理中止

#### ビジネスルール

- リポジトリ削除時、関連する投稿も連動して削除される

## 5. 画面構成

### 5.1 画面一覧

| 画面ID | 画面名 | パス | 認証 |
|--------|--------|------|------|
| S-001 | ログイン画面 | /admin/login | 不要 |
| S-002 | 管理画面トップ | /admin | 必要 |
| S-003 | リポジトリ一覧 | /admin/repositories | 必要 |
| S-004 | リポジトリ登録 | /admin/repositories/new | 必要 |

### 5.2 ログイン画面（S-001）

#### 画面要素

- アプリケーション名
- Googleでログインボタン
- エラーメッセージ表示領域（認証失敗時）

### 5.3 管理画面トップ（S-002）

#### 画面要素

- ヘッダー
  - アプリケーション名
  - ログインユーザー情報（名前、アバター）
  - ログアウトボタン
- ナビゲーション
  - リポジトリ管理へのリンク
- ダッシュボード
  - 登録リポジトリ数
  - 投稿数

### 5.4 リポジトリ一覧（S-003）

#### 画面要素

- ヘッダー（共通）
- リポジトリ一覧テーブル
- 新規登録ボタン

### 5.5 リポジトリ登録（S-004）

#### 画面要素

- ヘッダー（共通）
- 入力フォーム
  - リポジトリ名
  - URL
- 登録ボタン
- キャンセルボタン

## 6. データ要件

### 6.1 セッションデータ

ログイン時にセッションに保存するユーザー情報。

| 項目 | 説明 |
|------|------|
| email | メールアドレス |
| name | 表示名 |
| avatar_url | Googleアバター画像URL |

### 6.2 既存テーブル（変更なし）

`repositories` テーブルは既存のまま使用する。

| 項目名 | データ型 | 必須 | 説明 |
|--------|----------|------|------|
| id | INTEGER | ○ | 主キー |
| name | VARCHAR | ○ | リポジトリ名（一意） |
| url | VARCHAR | ○ | リポジトリURL |
| last_fetched_at | DATETIME | | 最終取得日時 |
| created_at | DATETIME | ○ | 作成日時 |
| updated_at | DATETIME | ○ | 更新日時 |

## 7. ルーティング

### 7.1 認証関連

| メソッド | パス | 機能 |
|----------|------|------|
| GET | /admin/login | ログイン画面表示 |
| POST | /auth/google_oauth2 | Google認証開始 |
| GET | /auth/google_oauth2/callback | 認証コールバック |
| DELETE | /admin/logout | ログアウト |

### 7.2 管理画面

| メソッド | パス | 機能 |
|----------|------|------|
| GET | /admin | 管理画面トップ |
| GET | /admin/repositories | リポジトリ一覧 |
| GET | /admin/repositories/new | リポジトリ登録画面 |
| POST | /admin/repositories | リポジトリ登録処理 |
| DELETE | /admin/repositories/:id | リポジトリ削除 |

## 8. セキュリティ考慮事項

### 8.1 CSRF対策

- OmniAuthリクエストにCSRFトークン検証を適用

### 8.2 セッション管理

- セッションはサーバーサイドで管理
- ログアウト時にセッションを完全に破棄

### 8.3 ドメイン制限

- `@takeyuweb.co.jp` ドメイン以外からのログインを拒否
- ドメイン検証はサーバーサイドで実施

## 9. 外部サービス連携

### 9.1 Google OAuth2

| 項目 | 説明 |
|------|------|
| 認証プロバイダー | Google |
| 認証方式 | OAuth 2.0 |
| 必要なスコープ | email, profile |
| 環境変数 | GOOGLE_CLIENT_ID, GOOGLE_CLIENT_SECRET |
