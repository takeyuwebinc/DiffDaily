# DiffDaily 機能設計書

**機能名**: DiffDaily（日次OSS変更要約）
**バージョン**: 1.0
**作成日**: 2026年1月7日
**更新日**: 2026年1月7日

> **設計書作成ガイドライン**
>
> この機能設計書は、実装の詳細に影響されないコアドメインの設計を記載します。
> 具体的なクラス設計や実装詳細は、実装中の改善によって変化するため、
> 以下の点を重視して作成しています：
>
> - **責務の明確化**: 何をする処理かを明確に定義
> - **入出力の仕様**: 処理に必要な入力と期待される出力
> - **処理フローの概要**: 大まかな処理手順（実装方法は含めない）
> - **抽象度の保持**: 具体的なクラス名・メソッド名は記載しない
> - **ドメイン知識の記録**: 業務ルールやビジネス制約を重視

## 1. 機能概要

### 1.1 目的

DiffDailyは、GitHubのOSSリポジトリにおける技術的変更を定点観測し、AIを用いて技術者向けの要約記事を自動生成・公開するシステムである。

- OSSの技術的変更を効率的にキャッチアップできる仕組みを提供
- Pull Requestの差分から本質的な変更内容を抽出し、日本語で解説
- 継続的な情報発信により技術コミュニティに貢献

### 1.2 主要機能

1. **GitHub変更取得**: 指定リポジトリのマージ済みPull Requestを取得し、ノイズをフィルタリング
2. **AI記事生成**: PR情報を基にAIで技術記事を生成
3. **記事管理**: 生成された記事をデータベースに保存・ステータス管理
4. **記事閲覧**: Web UIで記事一覧・詳細を表示
5. **日次バッチ処理**: 定期的に監視・記事生成を自動実行

### 1.3 処理フロー概要

#### 1.3.1 日次バッチ処理

1. 対象リポジトリを指定してジョブを起動
2. GitHub変更取得処理を実行
3. 取得したPRごとにAI記事生成処理を実行
4. 生成結果をデータベースに保存

#### 1.3.2 記事閲覧

1. ユーザーが記事一覧ページにアクセス
2. 公開済み記事を日時降順で表示
3. 記事をクリックして詳細ページを表示
4. 記事本文とメタデータを表示

## 2. データ要件

### 2.1 リポジトリ情報

#### 2.1.1 リポジトリマスタ
**テーブル名**: `repositories`

| 項目名 | キー | データ型 | 必須 | 説明 |
|--------|------|----------|------|------|
| id | PK | bigint | ○ | 主キー |
| name | UK | string | ○ | リポジトリ名（owner/repo形式） |
| url | | string | ○ | リポジトリURL |
| created_at | | datetime | ○ | 作成日時 |
| updated_at | | datetime | ○ | 更新日時 |

**制約**:
- UNIQUE KEY(name)

**目的**:
- 監視対象リポジトリの管理
- 記事との関連付け

**データ作成/更新タイミング**:
- システム初期設定時
- 新規リポジトリ追加時（将来の複数リポジトリ対応）

### 2.2 記事情報

#### 2.2.1 記事テーブル
**テーブル名**: `posts`

| 項目名 | キー | データ型 | 必須 | 説明 |
|--------|------|----------|------|------|
| id | PK | bigint | ○ | 主キー |
| repository_id | FK | bigint | ○ | リポジトリID |
| title | | string | ○ | 記事タイトル |
| body | | text | ○ | 記事本文（Markdown形式） |
| source_url | | string | | 元となるPRのURL |
| generated_by | | string | | 生成したAIモデル名 |
| published_at | | datetime | | 公開日時 |
| status | | string | ○ | ステータス |
| created_at | | datetime | ○ | 作成日時 |
| updated_at | | datetime | ○ | 更新日時 |

**制約**:
- FOREIGN KEY(repository_id) REFERENCES repositories(id)

**ステータス値**:
- `draft`: 下書き
- `published`: 公開済み
- `skipped`: スキップ（フィルタリング対象）

**目的**:
- 生成された記事の永続化
- 公開状態の管理

**データ作成/更新タイミング**:
- AI記事生成処理の完了時
- ステータス変更時

## 3. 処理詳細

### 3.1 GitHub変更取得処理

#### 3.1.1 責務
指定したGitHubリポジトリから過去24時間のマージ済みPull Requestを取得し、ノイズをフィルタリングする。

#### 3.1.2 入力
- リポジトリ名（owner/repo形式）
- 取得対象期間（デフォルト: 過去24時間）

#### 3.1.3 出力
フィルタリング後のPR情報リスト。各PRには以下を含む：
- PR番号
- タイトル
- 説明（Description）
- URL
- マージ日時
- ファイル差分（patch）

#### 3.1.4 処理フロー

1. **PR一覧取得**
   - GitHub APIを使用してマージ済みPRを取得
   - 指定期間内にマージされたPRを抽出

2. **ノイズフィルタリング**
   - フィルタリング条件に該当するPRを除外
   - 有効なPRのみを後続処理に渡す

3. **差分取得**
   - 各PRのファイル差分を取得
   - patch情報を付加

#### 3.1.5 エラー処理
- API接続エラー: エラーをログに記録し、処理を中断
- レート制限到達: エラーをログに記録し、処理を中断

### 3.2 AI記事生成処理

#### 3.2.1 責務
PR情報を基に、AIを使用して技術記事を生成する。

#### 3.2.2 入力
- リポジトリ名
- PR情報（番号、タイトル、説明、URL、差分）

#### 3.2.3 出力
- 生成された記事（Markdown形式）
- 使用したAIモデル名
- スキップフラグ（フィルタリング対象の場合）

#### 3.2.4 処理フロー

1. **プロンプト構築**
   - システムプロンプトを設定
   - PR情報をユーザープロンプトとして整形

2. **AI API呼び出し**
   - AIモデルに記事生成をリクエスト
   - レスポンスを取得

3. **結果判定**
   - AIがSKIPを返した場合はスキップフラグを設定
   - 有効な記事の場合はMarkdownテキストを返却

#### 3.2.5 エラー処理
- API接続エラー: エラーをログに記録
- レスポンス異常: エラーをログに記録

### 3.3 記事保存処理

#### 3.3.1 責務
生成された記事をデータベースに保存する。

#### 3.3.2 入力
- リポジトリ情報
- 記事情報（タイトル、本文、出典URL、モデル名）
- スキップフラグ

#### 3.3.3 出力
- 保存された記事レコード

#### 3.3.4 処理フロー

1. **ステータス決定**
   - スキップフラグがtrueの場合: `skipped`
   - 通常の場合: `published`

2. **レコード作成**
   - 記事情報をデータベースに保存
   - 公開済みの場合は`published_at`に現在日時を設定

### 3.4 記事一覧表示処理

#### 3.4.1 責務
公開済み記事の一覧を表示する。

#### 3.4.2 入力
- ページ番号（ページネーション用）

#### 3.4.3 出力
- 記事一覧（タイトル、公開日時、リポジトリ名、生成モデル名）
- ページネーション情報

#### 3.4.4 処理フロー

1. **データ取得**
   - ステータスが`published`の記事を取得
   - 公開日時の降順でソート

2. **ページネーション**
   - 指定されたページの記事を抽出

3. **表示データ整形**
   - 一覧表示に必要な情報を整形

### 3.5 記事詳細表示処理

#### 3.5.1 責務
個別記事の詳細を表示する。

#### 3.5.2 入力
- 記事ID

#### 3.5.3 出力
- 記事詳細（タイトル、本文、公開日時、リポジトリ名、出典URL、生成モデル名）

#### 3.5.4 処理フロー

1. **データ取得**
   - 指定IDの記事を取得
   - 関連するリポジトリ情報を取得

2. **Markdownレンダリング**
   - 本文をMarkdown形式で表示

3. **メタデータ表示**
   - 出典URL、生成モデル名、免責事項を表示

## 4. ビジネスルール

### 4.1 フィルタリングルール

#### 4.1.1 自動除外対象

以下の条件に該当するPRは記事生成の対象外とする：

**依存関係の自動更新**:
- Dependabotによる更新
- 判定方法: PR作成者がdependabotを含む

**ドキュメントのみの修正**:
- READMEや.mdファイルのみの変更
- 判定方法: 変更ファイルがドキュメントファイルのみ

**CI設定のみの変更**:
- GitHub Actions等のCI設定のみの変更
- 判定方法: 変更ファイルが.github/ディレクトリ内のみ

#### 4.1.2 AIによるスキップ判定

AI記事生成時に以下の条件に該当する場合、AIは「SKIP」を返却する：
- 単なるライブラリのバージョンアップ
- READMEやドキュメントのみの修正
- CI設定変更のみ

### 4.2 記事フォーマットルール

#### 4.2.1 記事構成

生成される記事は以下の構成とする：

1. **タイトル**: 「[リポジトリ名] 変更内容の要約」形式
2. **背景説明**: なぜその変更が必要だったか
3. **技術詳細**: コードや設定がどう変わったか
4. **コード例**: 可能な場合は使用例を提示

#### 4.2.2 メタデータブロック

記事末尾には以下のメタデータを付与する：
- Primary Source: PR番号とURL
- Generated by: AIモデル名 for DiffDaily

#### 4.2.3 対象読者

- 専門知識を持つエンジニア向け
- 事実とコードを中心に構成
- 日本語で記述

### 4.3 ステータス遷移

#### 4.3.1 ステータス定義

| ステータス | 説明 | 表示対象 |
|-----------|------|----------|
| draft | 下書き | 非表示 |
| published | 公開済み | 表示 |
| skipped | スキップ | 非表示 |

#### 4.3.2 遷移ルール

- 記事生成成功 → `published`
- AIがSKIP判定 → `skipped`
- 将来的な手動編集用 → `draft`（MVP外）

## 5. 画面表示機能

### 5.1 画面構成

#### 5.1.1 共通レイアウト
- **ヘッダー**: サービス名「DiffDaily」、コンセプト説明
- **メインコンテンツ**: 各ページ固有の内容
- **フッター**: コピーライト、免責事項

### 5.2 記事一覧画面

#### 5.2.1 表示要素

**記事カード**:
- タイトル（詳細ページへのリンク）
- 公開日時
- リポジトリ名
- 生成モデル名

**ページネーション**:
- ページ番号による遷移
- 前後ページへのリンク

#### 5.2.2 記事がない場合
- 「まだ記事がありません」メッセージを表示

### 5.3 記事詳細画面

#### 5.3.1 表示要素

**記事ヘッダー**:
- タイトル
- 公開日時
- リポジトリ名
- 戻るリンク

**記事本文**:
- Markdown形式でレンダリング

**メタデータセクション**:
- 出典（PRへのリンク）
- 生成モデル名
- AI生成に関する免責事項

### 5.4 エラーハンドリング

#### 5.4.1 エラー表示

| エラー種別 | 表示内容 |
|-----------|----------|
| 記事が見つからない | 404エラーページ |
| サーバーエラー | 500エラーページ |

## 6. バッチ処理機能

### 6.1 日次要約ジョブ

#### 6.1.1 責務
指定したリポジトリの変更を取得し、記事を生成・保存する一連の処理を実行する。

#### 6.1.2 トリガー
- 手動実行: コンソールからジョブを起動
- 定期実行: スケジューラーにより日次で起動（将来設定）

#### 6.1.3 処理フロー

1. **リポジトリ特定**
   - 入力からリポジトリを特定
   - リポジトリが存在しない場合はエラー

2. **変更取得**
   - GitHub変更取得処理を実行
   - 対象PRリストを取得

3. **記事生成ループ**
   - 各PRに対してAI記事生成処理を実行
   - 生成結果を記事保存処理に渡す

4. **完了ログ**
   - 処理結果をログに記録

#### 6.1.4 エラー処理
- 個別PR処理のエラー: ログに記録し、次のPRを処理
- 全体処理のエラー: ログに記録し、ジョブを終了

### 6.2 前提条件

- GitHub APIトークンが設定されていること
- AI APIキーが設定されていること
- 対象リポジトリがデータベースに登録されていること

---

**関連資料**:
- [DiffDaily 要件定義書](./requirements.md)
